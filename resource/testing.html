<!DOCTYPE html>
<html>
<head>
    <title>HTML5 Puzzle</title>

    <script>
	/* varibles */
	
	/* const */
	const img_num = 1 + Math.floor(Math.random()*4.999);
	const PUZZLE_DIFFICULTY = 2 + Math.floor(Math.random()*4.999);
	const PUZZLE_HOVER_TINT = '#009900';
	
 
	/* referrence */
	var _canvas; 
	var _stage;
 
	var _img;
	var _pieces;
	var _puzzleWidth;
	var _puzzleHeight;
	var _pieceWidth;
	var _pieceHeight;
	var _currentPiece;  //the piece now holding by mouse
	var _currentDropPiece; //the piece which is selected to be exchanged by upper one
 
	var _mouse;  /*position of mouse*/
	/* init_fuct*/
	
	function init(){
		_img = new Image(); /*create an image object*/
		_img.addEventListener('load',onImage,false); /*when event:"load" is end, trigger onImage*/
		
		// randomly choose a pic
		switch(img_num){
			case 1:
				_img.src = "1.jpg";
				break;
			case 2:
				_img.src = "2.jpg";
				break;
			case 3:
				_img.src = "3.jpg";
				break;
			case 4:
				_img.src = "4.jpg";
				break;
			case 5:
				_img.src = "5.jpg";
				break;
		}
	}
	
	function onImage(e){
		/*processing the loaded image*/
		_pieceWidth = Math.floor(_img.width / PUZZLE_DIFFICULTY) /*one piece of puzzle width*/
		_pieceHeight = Math.floor(_img.height / PUZZLE_DIFFICULTY) /*one piece of puzzle height*/
		_puzzleWidth = _pieceWidth * PUZZLE_DIFFICULTY; /*puzzle width(amost img width)*/
		_puzzleHeight = _pieceHeight * PUZZLE_DIFFICULTY; /*puzzle height(amost img width)*/
		setCanvas(); /*use these info to construct canvas*/
		initPuzzle(); /*use these to create puzzle*/
	}
	function setCanvas(){
		_canvas = document.getElementById('canvas'); /*make _canvas is canvas in body*/
		_stage = _canvas.getContext('2d'); /*conva is 2d*/
		_canvas.width = _puzzleWidth;      /*set conva = puzzle size*/
		_canvas.height = _puzzleHeight;    
		_canvas.style.border = "1px solid black"; /*border of conva is 1 pixel*/
	}
	
	
	///////////////////////////////////////////////////////
	function initPuzzle(){
		_pieces = [];
		_mouse = {x:0,y:0};
		_currentPiece = null;
		_currentDropPiece = null;
		_stage.drawImage(_img, 0, 0, _puzzleWidth, _puzzleHeight, 0, 0, _puzzleWidth, _puzzleHeight);
		createTitle("Click to Start Puzzle");
		buildPieces();
	}
	
	function createTitle(msg){
		_stage.fillStyle = "#000000";
		_stage.globalAlpha = .4;
		_stage.fillRect(100,_puzzleHeight - 40,_puzzleWidth - 200,40);
		_stage.fillStyle = "#FFFFFF";
		_stage.globalAlpha = 1;
		_stage.textAlign = "center";
		_stage.textBaseline = "middle";
		_stage.font = "20px Arial";
		_stage.fillText(msg,_puzzleWidth / 2,_puzzleHeight - 20);
	}
	
	function buildPieces(){
		var i;
		var piece;
		var xPos = 0;
		var yPos = 0;
		for(i = 0;i < PUZZLE_DIFFICULTY * PUZZLE_DIFFICULTY;i++){
			piece = {};
			piece.sx = xPos;
			piece.sy = yPos;
			_pieces.push(piece);
			xPos += _pieceWidth;
			if(xPos >= _puzzleWidth){
				xPos = 0;
				yPos += _pieceHeight;
			}
		}
		document.onmousedown = shufflePuzzle;
	}

	function shufflePuzzle(){
		_pieces = shuffleArray(_pieces);
		_stage.clearRect(0,0,_puzzleWidth,_puzzleHeight);
		var i;
		var piece;
		var xPos = 0;
		var yPos = 0;
		for(i = 0;i < _pieces.length;i++){
			piece = _pieces[i];
			piece.xPos = xPos;
			piece.yPos = yPos;
			_stage.drawImage(_img, piece.sx, piece.sy, _pieceWidth, _pieceHeight, xPos, yPos, _pieceWidth, _pieceHeight);
			_stage.strokeRect(xPos, yPos, _pieceWidth,_pieceHeight);
			xPos += _pieceWidth;
			if(xPos >= _puzzleWidth){
				xPos = 0;
				yPos += _pieceHeight;
			}
		}
		document.onmousedown = onPuzzleClick;
	}
	
	function shuffleArray(o){
		//here command will shuffle image
		for(var j, x, i = o.length; i; j = parseInt(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
		return o;
	}
	
	function onPuzzleClick(e){
		if(e.layerX || e.layerX == 0){
			_mouse.x = e.layerX - _canvas.offsetLeft;
			_mouse.y = e.layerY - _canvas.offsetTop;
		}
		else if(e.offsetX || e.offsetX == 0){
			_mouse.x = e.offsetX - _canvas.offsetLeft;
			_mouse.y = e.offsetY - _canvas.offsetTop;
		}
		_currentPiece = checkPieceClicked();
		if(_currentPiece != null){
			_stage.clearRect(_currentPiece.xPos,_currentPiece.yPos,_pieceWidth,_pieceHeight);
			_stage.save();
			_stage.globalAlpha = .9;
			_stage.drawImage(_img, _currentPiece.sx, _currentPiece.sy, _pieceWidth, _pieceHeight, _mouse.x - (_pieceWidth / 2), _mouse.y - (_pieceHeight / 2), _pieceWidth, _pieceHeight);
			_stage.restore();
			document.onmousemove = updatePuzzle;
			document.onmouseup = pieceDropped;
		}
	}
	
	function checkPieceClicked(){
		var i;
		var piece;
		for(i = 0;i < _pieces.length;i++){
			piece = _pieces[i];
			if(_mouse.x < piece.xPos || _mouse.x > (piece.xPos + _pieceWidth) || _mouse.y < piece.yPos || _mouse.y > (piece.yPos + _pieceHeight)){
				//PIECE NOT HIT
			}
			else{
				return piece;
			}
		}
		return null;
	}
	
	function updatePuzzle(e){
		_currentDropPiece = null;
		if(e.layerX || e.layerX == 0){
			_mouse.x = e.layerX - _canvas.offsetLeft;
			_mouse.y = e.layerY - _canvas.offsetTop;
		}
		else if(e.offsetX || e.offsetX == 0){
			_mouse.x = e.offsetX - _canvas.offsetLeft;
			_mouse.y = e.offsetY - _canvas.offsetTop;
		}
		_stage.clearRect(0,0,_puzzleWidth,_puzzleHeight);
		var i;
		var piece;
		for(i = 0;i < _pieces.length;i++){
			piece = _pieces[i];
			if(piece == _currentPiece){
				continue;
			}
			_stage.drawImage(_img, piece.sx, piece.sy, _pieceWidth, _pieceHeight, piece.xPos, piece.yPos, _pieceWidth, _pieceHeight);
			_stage.strokeRect(piece.xPos, piece.yPos, _pieceWidth,_pieceHeight);
			if(_currentDropPiece == null){
				if(_mouse.x < piece.xPos || _mouse.x > (piece.xPos + _pieceWidth) || _mouse.y < piece.yPos || _mouse.y > (piece.yPos + _pieceHeight)){
					//NOT OVER
				}
				else{
					_currentDropPiece = piece;
					_stage.save();
					_stage.globalAlpha = .4;
					_stage.fillStyle = PUZZLE_HOVER_TINT;
					_stage.fillRect(_currentDropPiece.xPos,_currentDropPiece.yPos,_pieceWidth, _pieceHeight);
					_stage.restore();
				}
			}
		}
		_stage.save();
		_stage.globalAlpha = .6;
		_stage.drawImage(_img, _currentPiece.sx, _currentPiece.sy, _pieceWidth, _pieceHeight, _mouse.x - (_pieceWidth / 2), _mouse.y - (_pieceHeight / 2), _pieceWidth, _pieceHeight);
		_stage.restore();
		_stage.strokeRect( _mouse.x - (_pieceWidth / 2), _mouse.y - (_pieceHeight / 2), _pieceWidth,_pieceHeight);
	}
	
	function pieceDropped(e){
		document.onmousemove = null;
		document.onmouseup = null;
		if(_currentDropPiece != null){
			var tmp = {xPos:_currentPiece.xPos,yPos:_currentPiece.yPos};
			_currentPiece.xPos = _currentDropPiece.xPos;
			_currentPiece.yPos = _currentDropPiece.yPos;
			_currentDropPiece.xPos = tmp.xPos;
			_currentDropPiece.yPos = tmp.yPos;
		}
		resetPuzzleAndCheckWin();
	}
	
	function resetPuzzleAndCheckWin(){
		_stage.clearRect(0,0,_puzzleWidth,_puzzleHeight);
		var gameWin = true;
		var i;
		var piece;
		for(i = 0;i < _pieces.length;i++){
			piece = _pieces[i];
			_stage.drawImage(_img, piece.sx, piece.sy, _pieceWidth, _pieceHeight, piece.xPos, piece.yPos, _pieceWidth, _pieceHeight);
			_stage.strokeRect(piece.xPos, piece.yPos, _pieceWidth,_pieceHeight);
			if(piece.xPos != piece.sx || piece.yPos != piece.sy){
				gameWin = false;
			}
		}
		if(gameWin){
			setTimeout(gameOver,500);
		}
	}
	
	function gameOver(){
		document.onmousedown = null;
		document.onmousemove = null;
		document.onmouseup = null;
		
		var c = document.getElementById("canvas");
		var ctx = c.getContext("2d");

		ctx.font = "20px Georgia";
		ctx.fillText("code 871: command in 117 and 243 # here is 239", 450, 600);
		ctx.fillText("please use notepad++ to open testing.html for check", 450, 620);
		
		//initPuzzle(); the command will reset puzzle
	}
    </script>
</head>
 
<body onload="init();">
    <canvas id="canvas"></canvas>
</body>
 
</html>